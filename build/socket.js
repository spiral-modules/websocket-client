!function(t){var e={};function n(s){if(e[s])return e[s].exports;var i=e[s]={i:s,l:!1,exports:{}};return t[s].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=t,n.c=e,n.d=function(t,e,s){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(s,i,function(e){return t[e]}.bind(null,i));return s},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";function s(t){return`sf:${t}`}n.r(e);class i{constructor(){this.callbacks={}}get(t){return this.callbacks[s(t)]}add(t,e,n){const i=s(t);this.callbacks[i]=this.callbacks[i]||[],this.callbacks[i].push({fn:e,channel:n||null})}remove(t,e,n){if(!t&&!e&&!n)return void(this.callbacks={});const i=t?[s(t)]:Object.keys(this.callbacks);e||n?this.removeCallback(i,e,n):this.removeAllCallbacks(i)}removeCallback(t,e,n){t.forEach(t=>{const s=this.callbacks[t]||[];this.callbacks[t]=s.filter(t=>{const s=e&&e===t.fn,i=n&&n===t.channel;return!s&&!i}),0===this.callbacks[t].length&&delete this.callbacks[t]})}removeAllCallbacks(t){t.forEach(t=>{delete this.callbacks[t]})}}class o{constructor(){this.callbacks=new i}bind(t,e,n){return this.callbacks.add(t,e,n),this}unbind(t,e,n){return this.callbacks.remove(t,e,n),this}emit(t,e){const n=this.callbacks.get(t),s=e&&e.context?e.context.channel:null;return n&&n.length>0&&n.forEach(t=>{const n=t.channel===s;(!t.channel||!s||n)&&t.fn(e)}),this}}class r extends o{constructor(t,e){super(),this.name=t,this.socket=e,this.subscribed=!1,this.subscriptionCancelled=!1}trigger(t,e){return this.subscribed||console.warn("Client event triggered before channel 'subscription_succeeded' event"),this.socket.sendEvent(t,e,this.name)}disconnect(){this.subscribed=!1}join(){this.subscribed||(this.subscriptionCancelled=!1,this.subscribed=!0,this.socket.joinChannel(this.name))}subscribe(t,e){this.socket.subscribe(t,e,this.name)}unsubscribe(t,e){this.socket.unsubscribe(t,e,this.name)}leaveChannel(){this.subscribed=!1,this.socket.leaveChannel(this.name)}cancelSubscription(){this.subscriptionCancelled=!0}reinstateSubscription(){this.subscriptionCancelled=!1}}const c=["@"];class a extends o{constructor(t,e){super(),this.id=t,this.transport=e,this.bindListeners()}send(t){return!!this.transport&&this.transport.send(t)}sendEvent(t,e,n){const s={type:t,data:e,error:null};return n&&(s.context={channel:n}),this.send((t=>{const e={cmd:t.type,args:t.data};return JSON.stringify(e)})(s))}close(){this.transport&&this.transport.close()}bindListeners(){const t=t=>{this.transport&&(this.transport.unbind("message",t.message),this.transport.unbind("error",t.error),this.transport.unbind("closed",t.closed))},e={message:t=>{let e=null;try{e=(t=>{if(t){const e=JSON.parse(t),n=t=>{let e=t;return c.forEach(n=>{t&&t[0]===n&&(e="")}),String(e)};return{type:"sfSocket:message",error:null,data:e.payload||null,context:{...e.topic?{channel:n(e.topic)}:{}}}}return{type:"MessageParseError",error:`messageEvent: ${t} not contains data property`,data:null}})(t.data)}catch(e){this.emit("error",{type:"MessageParseError",error:e,data:"string"==typeof t?t:JSON.stringify(t)})}e&&("sfSocket:error"===e.type?this.emit("error",{type:"sfSocket:error",data:e.data,error:null}):this.emit("message",e))},error:t=>{this.emit("error",{type:"sfSocket:error",error:t,data:null})},closed:n=>{t(e),n&&n.context&&n.context.code&&this.handleCloseEvent(n),this.transport=null,this.emit("closed")}};this.transport&&(this.transport.bind("message",e.message),this.transport.bind("error",e.error),this.transport.bind("closed",e.closed))}handleCloseEvent(t){const e=(t=>t.context&&t.context.code?t.context.code<4e3&&t.context.code>=1002&&t.context.code<=1004?{...t,error:"socket is unavailable"}:t:(console.error("socket event do not contain close code"),{...t,error:"connection refused"}))(t);"sfSocket:closed"===e.type?this.emit("close",e):this.emit("error",e)}}class l extends o{constructor(t,e){super(),this.initialize=()=>{const t=this;t.hooks.isInitialized()?t.changeState("initialized"):t.onClose()},this.hooks=t,this.name=e,this.state="new"}connect(){if(this.socket||"initialized"!==this.state)return!1;const{url:t}=this.hooks;try{this.socket=this.hooks.getSocket(t)}catch(t){return setTimeout(()=>{this.onError(t),this.changeState("closed")}),!1}return this.bindListeners(),this.changeState("connecting"),!0}close(){return!!this.socket&&(this.socket.close(),!0)}send(t){return"open"===this.state&&(setTimeout(()=>{this.socket&&this.socket.send(t)}),!0)}unbindListeners(){this.socket&&(this.socket.onopen=null,this.socket.onerror=null,this.socket.onclose=null,this.socket.onmessage=null)}onOpen(){this.changeState("open"),this.socket&&(this.socket.onopen=null)}onError(t){this.emit("error",{type:"sfSocket:error",error:t||"websocket connection error",data:null})}onClose(t){t?this.changeState("closed",{type:t.wasClean?"sfSocket:closed":"sfSocket:error",data:t.wasClean?t.reason:null,error:t.wasClean?null:t.reason,context:{code:t.code}}):this.changeState("closed"),this.unbindListeners(),this.socket=void 0}onMessage(t){this.emit("message",{type:"sfSocket:message",data:"string"==typeof t.data?t.data:JSON.stringify(t.data),error:null})}bindListeners(){this.socket&&(this.socket.onopen=()=>{this.onOpen()},this.socket.onerror=()=>{this.onError()},this.socket.onclose=t=>{this.onClose(t)},this.socket.onmessage=t=>{this.onMessage(t)})}changeState(t,e){this.state=t,this.emit(t,e)}}class h{constructor(t,e){this.options=e||{};const n=`${`ws${e.useTLS?"s":""}`}://${e.useTLS?`${e.host}:${e.portTLS}`:`${e.host}:${e.port}`}/${e.path}`;this.hooks={url:n,isInitialized:()=>Boolean(window.WebSocket),getSocket:t=>new(0,window.WebSocket)(t)},this.name=t}connect(t){let e=!1;const n=new l(this.hooks,this.name),s=()=>{n.unbind("initialized",s),n.connect()},i=()=>{n.unbind("initialized",s),n.unbind("open",o),n.unbind("error",r),n.unbind("closed",c)},o=()=>{e=!0,i();const s=new a("",n);t(null,s)},r=e=>{i(),t(e)},c=()=>{i()};return n.bind("initialized",s),n.bind("open",o),n.bind("error",r),n.bind("closed",c),n.initialize(),{abort:()=>{e||(i(),n.close())}}}}class u extends o{constructor(t){super(),this.options=t||{},this.state="initialized",this.connection=null,this.usingTLS=Boolean(t.useTLS),this.errorCallbacks=this.buildErrorCallbacks(),this.connectionCallbacks=this.buildConnectionCallbacks(this.errorCallbacks),this.transport=new h("ws",t),this.runner=null,this.unavailableTimer=0,this.retryTimer=0}connect(){this.connection||this.runner||(this.updateState("connecting"),this.startConnecting(),this.setUnavailableTimer())}send(t){return!!this.connection&&this.connection.send(t)}sendEvent(t,e,n){return!!this.connection&&this.connection.sendEvent(t,e,n)}disconnect(){this.disconnectInternally(),this.updateState("disconnected")}startConnecting(){const t=(e,n)=>{e?this.runner=this.transport.connect(t):(this.abortConnecting(),this.clearUnavailableTimer(),this.setConnection(n),this.updateState("connected"))};this.runner=this.transport.connect(t)}abortConnecting(){this.runner&&(this.runner.abort(),this.runner=null)}disconnectInternally(){if(this.abortConnecting(),this.clearRetryTimer(),this.clearUnavailableTimer(),this.connection){const t=this.abandonConnection();t&&t.close()}}retryIn(t){t>0&&this.emit("connecting",{type:"sfSocket:connecting",data:String(Math.round(t/1e3)),error:null}),this.retryTimer=setTimeout(()=>{this.disconnectInternally(),this.connect()},t||0)}clearRetryTimer(){this.retryTimer&&(this.retryTimer&&clearTimeout(this.retryTimer),this.retryTimer=0)}setUnavailableTimer(){this.unavailableTimer=setTimeout(()=>{this.updateState("unavailable")},this.options.unavailableTimeout)}clearUnavailableTimer(){this.unavailableTimer&&clearTimeout(this.unavailableTimer),this.unavailableTimer=0}buildConnectionCallbacks(t){return{...t,message:t=>{this.emit("message",t)},error:t=>{this.emit("error",t)},closed:t=>{this.abandonConnection(),this.shouldRetry()&&this.retryIn(1e3),this.emit("closed",t)}}}buildErrorCallbacks(){const t=t=>e=>{e.error&&this.emit("error",{type:"sfSocket:error",data:null,error:e.error}),t(e)};return{refused:t(()=>{this.disconnect()}),unavailable:t(()=>{this.retryIn(1e3)})}}setConnection(t){this.connection=t,this.connection&&(this.connection.bind("message",this.connectionCallbacks.message),this.connection.bind("error",this.connectionCallbacks.error),this.connection.bind("closed",this.connectionCallbacks.closed))}abandonConnection(){if(!this.connection)return null;this.connection.unbind("message",this.connectionCallbacks.message),this.connection.unbind("error",this.connectionCallbacks.error),this.connection.unbind("closed",this.connectionCallbacks.closed);const{connection:t}=this;return this.connection=null,t}updateState(t){const e=this.state;this.state=t,e!==t&&this.emit(t)}shouldRetry(){return"connecting"===this.state||"connected"===this.state}}const d="join",b="leave",p={host:"",port:80,portTLS:443,path:"",unavailableTimeout:1e4,useTLS:!1,useStorage:!1};class g{constructor(t){if(!t||"object"!=typeof t)throw new Error("sfSocket options should be an object");const e=t||{};if(this.config={...p,...e},this.channels={},this.eventsDispatcher=new o,this.hasStorage=Boolean(this.config.useStorage&&window&&window.localStorage),this.connection=new u(this.config),this.connection.bind("connected",()=>{Object.keys(this.channels).forEach(t=>{this.subscribeChannel(t)})}),this.connection.bind("message",t=>{this.eventsDispatcher.emit("message",t)}),this.connection.bind("connecting",()=>{this.channelsDisconnect()}),this.connection.bind("disconnected",()=>{this.channelsDisconnect()}),this.connection.bind("error",t=>{console.error(t)}),g.instances.push(this),g.isReady&&this.connect(),this.hasStorage){const t=this.getStorage();t&&t.forEach(t=>{this.subscribeChannel(t)})}}static ready(){g.isReady=!0,g.instances.forEach(t=>{t.connect()})}connect(){this.connection.connect()}disconnect(){this.connection.disconnect()}sendEvent(t,e,n){return this.connection.sendEvent(t,e,n)}join(t){return this.sendEvent(d,t)}leave(t){return this.sendEvent(b,t)}listen(t){t.forEach(t=>{"connected"===this.connection.state?this.joinChannel(t):this.subscribeChannel(t)})}stopListen(t){t.forEach(t=>{const e=this.removeChannel(t);e&&"connected"===this.connection.state&&e.leaveChannel()})}subscribe(t,e,n){return this.connection.bind(t,e,n)}unsubscribe(t,e,n){return this.connection.unbind(t,e,n)}channel(t){return this.subscribeChannel(t)}addChannel(t,e){return this.channels[t]||(this.channels[t]=new r(t,e)),this.channels[t]}joinChannel(t){return this.addStorageChannel(t),this.sendEvent(d,[t])}leaveChannel(t){return this.removeStorageChannel(t),this.sendEvent(b,[t])}findChannel(t){return this.channels[t]}removeChannel(t){const e=this.channels[t];return delete this.channels[t],e}channelsDisconnect(){Object.values(this.channels).forEach(t=>t.disconnect())}subscribeChannel(t){const e=this.addChannel(t,this);return e.subscriptionCancelled?e.reinstateSubscription():"connected"===this.connection.state&&e.join(),e}getStorage(){if(this.hasStorage){const t=window.localStorage.getItem("sfsocket_storage");return t?JSON.parse(t):null}return null}addStorageChannel(t){if(this.hasStorage){const e=this.getStorage();if(e){const n=e.filter(e=>e!==t);n.push(t),this.setStorage(n)}else this.setStorage([t])}}removeStorageChannel(t){if(this.hasStorage){const e=this.getStorage();if(e){const n=e.filter(e=>e!==t);n.length?this.setStorage(n):this.clearStorage()}}}setStorage(t){return this.hasStorage?window.localStorage.setItem("sfsocket_storage",JSON.stringify(t)):null}clearStorage(){return this.hasStorage?window.localStorage.removeItem("sfsocket_storage"):null}}g.instances=[],g.isReady=!1,n.d(e,"makeSocketOptions",(function(){return m})),n.d(e,"SFSocket",(function(){return g}));const m=t=>{const e=new URL(t),n=e.protocol?e.protocol.replace(":",""):null;return e.hostname&&e.port&&n?{host:e.hostname,port:e.port,path:n}:null};e.default=g}]);
//# sourceMappingURL=socket.js.map